<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>HYPE Funding — Pro Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <style>
      :root { --bg:#0b1221; --panel:rgba(16,22,40,.85); --border:#1c2543; --text:#e7ecf7; --muted:#a2aec6; --accent:#9ec5ff; --green:#10b981; --red:#ef4444; }
      body { background:var(--bg); color:var(--text); font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto; }
      .wrap { max-width:1040px; margin:0 auto; }
      .glass { background:var(--panel); border:1px solid var(--border); border-radius:14px; box-shadow:0 1px 0 rgba(255,255,255,.03) inset, 0 8px 30px rgba(0,0,0,.35); }
      .title { font-weight:800; }
      .subtle { color:var(--muted); }
      .accent { color:var(--accent); }
      .value-xl { font-size:clamp(28px,4vw,40px); font-weight:800; }
      .value-lg { font-size:clamp(22px,3vw,28px); font-weight:800; }
      .chip { display:inline-flex; gap:6px; align-items:center; padding:6px 10px; border-radius:999px; border:1px solid var(--border); background:rgba(148,163,184,.12); }
      .btn-ghost { border:1px solid var(--border); color:var(--text); background:rgba(255,255,255,.02); }
      .btn-ghost:hover { border-color:var(--accent); color:var(--accent); }
      .grid-gap { gap:14px; }
      .progress-ring{ transform:rotate(-90deg); }
      .ring-bg{ stroke:rgba(162,174,198,.2); }
      .ring-fg{ stroke:var(--accent); }
    </style>
  </head>
  <body>
    <div id="root" class="wrap container py-3"></div>

    <script type="text/babel">
    {% raw %}
      const { useEffect, useState, useRef } = React;
      const format = (v,d=6)=> (v==null||isNaN(v)?'—':Number(v).toFixed(d));
      const pct = (v)=> (v==null||isNaN(v)?'—':(Number(v)*100).toFixed(1)+'%');

      function useSummary(autoMs=10000){
        const [data,setData]=useState(null); const [loading,setLoading]=useState(true); const [err,setErr]=useState(null);
        const serverOffsetRef=useRef(0);
        async function fetchIt(){
          try{ const res=await fetch('/api/summary',{cache:'no-store'}); if(!res.ok) throw new Error('fetch failed'); const j=await res.json();
            const localNow=Date.now(); serverOffsetRef.current = (j.serverTime ?? localNow) - localNow; // ms difference
            setData({...j, _serverOffset: serverOffsetRef.current}); setErr(null);
          }catch(e){ setErr(e.message);} finally{ setLoading(false); }
        }
        useEffect(()=>{ fetchIt(); },[]);
        useEffect(()=>{ const id=setInterval(fetchIt,autoMs); return ()=>clearInterval(id); },[autoMs]);
        return { data, loading, err, refresh: fetchIt };
      }

      function Countdown({ nextMs, serverOffset=0, onZero }){
        const [t,setT]=useState(Date.now());
        useEffect(()=>{ const id=setInterval(()=>setT(Date.now()), 250); return ()=>clearInterval(id); },[]); // smoother tick 4/s
        const nowAdj=t+serverOffset; if(!nextMs) return <span className="subtle">unknown</span>;
        let remain=Math.max(0, nextMs - nowAdj); if(remain<=250 && onZero) onZero();
        const h=String(Math.floor(remain/3600000)).padStart(2,'0'); remain%=3600000;
        const m=String(Math.floor(remain/60000)).padStart(2,'0'); remain%=60000;
        const s=String(Math.floor(remain/1000)).padStart(2,'0');
        return <span className="accent value-lg">{h}:{m}:{s}</span>;
      }

      function ActionPanel({ d, refresh }){
        const dir=d.predictedDirection?.direction; const prob=d.predictedDirection?.prob_positive ?? null;
        const suggestion = dir==='positive'?'Short to receive funding' : dir==='negative'?'Long to receive funding' : 'Wait';
        const open=()=>window.open('https://app.hyperliquid.xyz/perps/HYPE','_blank');
        return (
          <div className="glass p-3">
            <div className="d-flex justify-content-between align-items-center mb-2">
              <div className="title" style={{fontSize:'22px'}}>Action</div>
              <span className="chip"><i data-feather={dir==='positive'?'trending-up':dir==='negative'?'trending-down':'help-circle'} width="16"></i>{dir?dir.charAt(0).toUpperCase()+dir.slice(1):'N/A'} • {pct(prob)}</span>
            </div>
            <div className="d-flex justify-content-between align-items-center flex-wrap">
              <div className="pe-3">
                <div className="subtle">Suggested</div>
                <div className="value-xl" style={{color: dir==='positive'?'var(--red)': dir==='negative'?'var(--green)':'var(--accent)'}}>{suggestion}</div>
                <div className="subtle mt-1">HL Predicted Rate: <span className="accent">{format(d.predictedFundingRate?.pred_next_funding,8)}</span></div>
                <div className="mt-2 d-flex gap-2">
                  <button className="btn btn-ghost" onClick={open}><i data-feather="external-link" width="16" className="me-1"></i>Open Hyperliquid</button>
                  <button className="btn btn-outline-info" onClick={refresh}><i data-feather="refresh-ccw" width="16" className="me-1"></i>Refresh</button>
                </div>
              </div>
              <div className="text-end">
                <div className="subtle">Next Funding In</div>
                <Countdown nextMs={d.nextFundingTime} serverOffset={d._serverOffset||0} />
              </div>
            </div>
          </div>
        );
      }

      function App(){
        const { data, loading, err, refresh } = useSummary();
        useEffect(()=>{ feather.replace({'stroke-width':2}); });
        return (
          <div>
            <div className="d-flex justify-content-between align-items-center mb-3">
              <div>
                <div className="title" style={{fontSize:'26px'}}>HYPE Funding</div>
                <div className="subtle">Minimal, actionable signal</div>
              </div>
              <button className="btn btn-ghost" onClick={refresh}><i data-feather="refresh-ccw" width="16" className="me-1"></i>Refresh</button>
            </div>
            {loading && <div className="glass p-3" style={{height:120}}></div>}
            {err && <div className="alert alert-danger glass" role="alert">{err}</div>}
            {data && (
              <div className="d-flex flex-column grid-gap">
                <ActionPanel d={data} refresh={refresh} />
                <div className="row grid-gap">
                  <div className="col-lg-6">
                    <div className="glass p-3">
                      <div className="title mb-1" style={{fontSize:'18px'}}>Predicted Funding Rate</div>
                      <div className="d-flex justify-content-between align-items-end">
                        <div>
                          <div className="subtle">Rate</div>
                          <div className="value-xl accent">{format(data.predictedFundingRate?.pred_next_funding,8)}</div>
                        </div>
                        <span className="chip">Models {data.predictedFundingRate?.n_models ?? '—'}</span>
                      </div>
                      <div className="subtle mt-2">Std: <span className="accent">{data.predictedFundingRate?.pred_std ? Number(data.predictedFundingRate.pred_std).toExponential(2) : '—'}</span></div>
                    </div>
                  </div>
                  <div className="col-lg-6">
                    <div className="glass p-3">
                      <div className="title mb-1" style={{fontSize:'18px'}}>Accuracy (Rolling)</div>
                      <div className="d-flex justify-content-between align-items-end">
                        <div>
                          <div className="subtle">Accuracy</div>
                          <div className="value-xl" style={{color:'var(--green)'}}>{data.accuracy?.accuracy===null?'N/A':pct(data.accuracy?.accuracy)}</div>
                        </div>
                        <span className="chip">Count {data.accuracy?.count ?? 0}</span>
                      </div>
                    </div>
                  </div>
                </div>
                <div className="glass p-3">
                  <div className="title mb-1" style={{fontSize:'18px'}}>Live</div>
                  <div className="d-flex justify-content-between align-items-end">
                    <div>
                      <div className="subtle">Funding</div>
                      <div className="value-xl accent">{format(data.liveFunding?.funding,6)}</div>
                      <div className="subtle mt-1">Premium: <span className="accent">{format(data.liveFunding?.premium,6)}</span> · Mark: <span className="accent">{data.liveFunding?.markPx ?? '—'}</span> · Oracle: <span className="accent">{data.liveFunding?.oraclePx ?? '—'}</span></div>
                    </div>
                    <div className="text-end">
                      <div className="subtle">Next Funding In</div>
                      <Countdown nextMs={data.nextFundingTime} serverOffset={data._serverOffset||0} />
                    </div>
                  </div>
                </div>
              </div>
            )}
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
    {% endraw %}
    </script>
  </body>
</html> 